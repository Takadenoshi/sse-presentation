<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />
<meta name="author" content="tasos@kadena.io" />
<meta name="date" content="2023-09-29" />
<title>Takadenoshi ‚Äì Server-Sent Events</title>
<style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<link rel="stylesheet" type="text/css" media="screen, projection, print" href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
<link rel="stylesheet" type="text/css" media="screen, projection, print" href="assets/styles/index.css" />
<link rel="stylesheet" type="text/css" media="screen, projection, print" href="assets/styles/fonts.css" />
<link rel="stylesheet" type="text/css" media="screen, projection, print" href="assets/styles/slides.css" />
<script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js" charset="utf-8" type="text/javascript"></script>
<script>
    window.showvideo = () => {
      const video = document.getElementById('video-cover');
      video.playbackRate = 0.5;
      video.play();
      video.style.display = 'block';
    }
</script>
</head>
<body>
  
    <img src="assets/images/bg.png" class="background" />
  
      <video id="video-cover" loop muted oncanplay="showvideo()">
          <source src="assets/videos/kd-back.webm" type="video/webm" />
      </video>
    
    <div class="slide titlepage">
                <div class="icons">
              <img src="assets/icons/tasos.jpeg" alt="Logo" />
              <img src="assets/icons/k-internal-icon.jpg" alt="Logo" />
              <img src="assets/icons/logo_reactlive.svg" alt="Logo" />
            </div>
        <div class="container">
      <h1 class="title">Server-Sent Events</h1>
                  <p class="author">
        tasos@kadena.io
      </p>
                    <p class="date">September 29, 2023</p>
          </div>
  </div>
    
<div id="whois-tasos-bitsios" class="slide section level1">
<h1>whois ‚ÄúTasos Bitsios‚Äù</h1>
<ul>
<li>Full stack software developer ~ 13 years
<ul>
<li>Somwehat backend-leaning</li>
<li>Mostly JS/TS/node.js/React</li>
<li>Mostly worked in startups</li>
</ul></li>
<li>Long time listener, first time speaker</li>
<li>Developer @ <a href="https://kadena.io/">Kadena</a> Developer Experience team</li>
<li>Socials:
<ul>
<li><a href="https://github.com/takadenoshi">@Takadenoshi</a> on Github</li>
<li><a href="https://x.com/takadenoshi">@Takadenoshi</a> on X</li>
</ul></li>
</ul>
</div>
<div id="whois-kadena" class="slide section level1">
<h1>whois ‚ÄúKadena‚Äù</h1>
<ul>
<li>Scalabe PoW Blockchain</li>
<li>Focus on:
<ul>
<li>Scalability</li>
<li>Intelligent &amp; secure smart contracts
<ul>
<li>Formal verification</li>
<li>Source available</li>
</ul></li>
</ul></li>
<li>Socials
<ul>
<li><a href="https://github.com/kadena-io">@kadena-io</a> and <a href="https://github.com/kadena-community">@kadena-community</a> on Github</li>
<li><a href="https://x.com/kadena_io">@kadena_io</a> on X</li>
<li><a href="https://kadena.io">kadena.io</a> on the Interwebs</li>
</ul></li>
</ul>
</div>
<div id="server-sent-events-sse" class="slide section level1">
<h1>Server-Sent Events (SSE)</h1>
<h2 id="a-server-push-protocol">A server-push protocol</h2>
<ul>
<li>Unidirectional: Server -&gt; Client</li>
<li>Essentially a streaming HTTP/1.1 GET (or HTTP/2)
<ul>
<li>Connection is kept open, server writes more data as it becomes available</li>
</ul></li>
<li>(Web) Client side interacts with SSE endpoints using <code>EventSource</code>
<ul>
<li>Register <code>data</code> or custom <code>event</code> callbacks</li>
<li>A MessageEvent Interface</li>
</ul></li>
<li>With reconnection batteries included*
<ul>
<li>Terms and conditions may apply</li>
</ul></li>
</ul>
</div>
<div id="use-cases" class="slide section level1">
<h1>Use cases</h1>
<p>Replaces polling. Stream any kind of update from the server.</p>
<ul>
<li>notifications</li>
<li>live ticker data</li>
<li>live sports events</li>
<li>anything that is UTF-8 suitable</li>
</ul>
</div>
<div id="what-is-this-new-thing" class="slide section level1">
<h1>What is this <del>new</del> thing?</h1>
<p>ü•≥ SSE is 19 years old</p>
<p>üîß 13 years of mainstream support</p>
<hr />
<ul>
<li>2004 Sep 23 ¬∑ <a href="https://web.archive.org/web/20041009144718/http://www.whatwg.org/specs/web-apps/current-work/#server-sent">Server-sent DOM Events</a>, Ian Hickson, Opera Software, WHATWG Web Applications 1.0</li>
<li>2006 ¬∑ [Production] Opera browser implementation</li>
<li>2009 ¬∑ <a href="https://www.w3.org/TR/2009/WD-eventsource-20090423/">W3C Working Draft</a>, Ian Hickson, Google Inc</li>
<li>2010 ¬∑ [Production] Safari v5, Chrome v6</li>
<li>2011 ¬∑ [Production] Firefox v6,</li>
<li>2015 ¬∑ <a href="https://www.w3.org/TR/2015/REC-eventsource-20150203/">W3C Recommendation</a></li>
</ul>
<hr />
<p>History: <a href="https://www.w3.org/TR/2015/REC-eventsource-20150203/">W3C Publication History</a></p>
<p>Current: <a href="https://html.spec.whatwg.org/multipage/server-sent-events.html#server-sent-events">HTML Living Standard ¬ß 9.2</a></p>
</div>
<div id="playground-repo---download-me" class="slide section level1">
<h1>Playground repo - download me!</h1>
<div class="columns">
<div class="column" style="width:60%;">
<p>Play-along repository:</p>
<ul>
<li>SSE server (express)</li>
<li>React app</li>
<li>Presentation</li>
</ul>
<p><a href="https://github.com/takadenoshi/sse-presentation">github.com/takadenoshi/sse-presentation</a></p>
<p>Useful for examining behaviors, browser implementation differences.</p>
<p>Repo link in QR ‚û°</p>
</div><div class="column" style="width:38%;">
<p><img src="assets/images/qr.png" /></p>
</div>
</div>
</div>
<div id="minimum-viable-sse-response" class="slide section level1">
<h1>Minimum Viable SSE response</h1>
<p>The simplest server-sent event stream specifies just <code>data</code> events.</p>
<p>Example with 2 events:</p>
<pre><code>&gt; GET /stream/hello HTTP/1.1

&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/event-stream

&lt; data: Hello\n\n

&lt; data: ReactLive are you there?\n\n</code></pre>
<p>Content-Type is <code>text/event-stream</code></p>
<p>Events separated by two newline characters <code>\n\n</code></p>
<p>Data is encoded in UTF-8 (mandatory)</p>
<p><sup><a href="https://github.com/takadenoshi/sse-presentation">Playground</a>: ‚Äúsimple‚Äù scenario</sup></p>
</div>
<div id="simple-eventsource-consumer" class="slide section level1">
<h1>Simple EventSource consumer</h1>
<p>Server-sent events are consumed with <code>EventSource</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource javascript numberLines"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">const</span> source <span class="op">=</span> <span class="kw">new</span> <span class="bu">EventSource</span>(<span class="st">&quot;http://localhost:3001/stream/simple&quot;</span>)<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">// &quot;message&quot; event emitted for each &quot;data&quot; event received</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>source<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;message&quot;</span><span class="op">,</span> <span class="bu">event</span> <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="op">++</span>i<span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span></code></pre></div>
<p>The exmaple from the previous slide would trigger the callback twice, logging:</p>
<div class="columns">
<div class="column" style="width:50%;">
<pre><code>&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/event-stream

&lt; data: Hello\n\n

&lt; data: ReactLive are you there?\n\n</code></pre>
</div><div class="column" style="width:50%;">
<pre><code>


1 Hello

2 ReactLive are you there?</code></pre>
</div>
</div>
</div>
<div id="named-events" class="slide section level1">
<h1>Named Events</h1>
<p>You can ‚Äúnamespace‚Äù your events using the <code>event</code> field with any custom name:</p>
<pre><code>&lt; event: goal
&lt; data: &quot;ARS-LIV 1-1 45&quot;\n\n

&lt; event: spectator-chat
&lt; data: &quot;Did you see that ludicrous display just now&quot;\n\n</code></pre>
<p>The <code>goal</code> and <code>spectator-chat</code> events are handled separately on the frontend</p>
<ul>
<li>Allows multiplexing / routing events
<ul>
<li>no need for pattern matching on a shared data payload</li>
</ul></li>
</ul>
</div>
<div id="comments" class="slide section level1">
<h1>Comments</h1>
<p>Any lines starting with <code>:</code> (colon) are interpreted as comments</p>
<pre><code>&lt; data: this or that\n\n

&lt; :TODO emit some events in the near future</code></pre>
<p>These are ignored on the client-side</p>
</div>
<div id="reconnection-1" class="slide section level1">
<h1>Reconnection (1)</h1>
<p>By default*, EventSource consumers will reconnect if the connection is interrupted.</p>
<p><sup>* <em>with implementation-specific caveats</em></sup></p>
<p>The default reconnection timeout is up to each browser (empirically: between 3-5 s.)</p>
<h2 id="custom-timeouts">Custom timeouts</h2>
<p>The reconnection timeout can be customized.</p>
<p>Emit a <code>retry:</code> field in any of the events:</p>
<pre><code>&lt; retry: 2500
&lt; data: Hello!\n\n</code></pre>
<ul>
<li>Value is in milliseconds</li>
<li>Timeouts are linear</li>
</ul>
<p><sup><a href="https://github.com/takadenoshi/sse-presentation">Playground</a>: ‚ÄúRetry-flaky‚Äù scenario</sup></p>
</div>
<div id="reconnection-2" class="slide section level1">
<h1>Reconnection (2)</h1>
<h2 id="computer-can-say-no">Computer can say no</h2>
<p>A server can signal ‚Äúdo not reconnect‚Äù:</p>
<ul>
<li>with a <code>Content-Type</code> header other than <code>text/event-stream</code></li>
<li>with a <code>2xx</code> response other than 200
<ul>
<li>301, 307 redirects to a 200 are OK</li>
</ul></li>
</ul>
<p><sup><a href="https://github.com/takadenoshi/sse-presentation">Playground</a>: ‚ÄúNot SSE‚Äù scenario</sup></p>
</div>
<div id="reconnection-3---last-event-id" class="slide section level1">
<h1>Reconnection (3) - Last-Event-ID</h1>
<p>Events can include an <code>id</code> field with any UTF-8 string as value.</p>
<p>Connection interrupted? Reconnection header <code>Last-Event-ID</code> set to the last id received.</p>
<p>This allows the server to resume gracefully.</p>
<hr />
<p>If this is the last event received in a stream that disconnects:</p>
<pre><code>&lt; id: data-0
&lt; retry: 5000
&lt; data: Data Zero event\n</code></pre>
<p>Then the connection timeout will be 5 seconds, and the <code>Last-Event-ID</code> header will be set to <code>data-0</code>.</p>
<pre><code>&gt; GET /stream/notifications HTTP/1.1
&gt; Host: localhost:3001
&gt; Last-Event-ID: data-0</code></pre>
<p><sup><a href="https://github.com/takadenoshi/sse-presentation">Playground</a>: ‚Äúnotifications‚Äù scenario</sup></p>
</div>
<div id="full-sse-response" class="slide section level1">
<h1>Full SSE response</h1>
<div class="columns">
<div class="column" style="width:45%;">
<p>Entire SSE gramar: 4+1 fields</p>
<ul>
<li>Setting reconnection time <code>retry: 2000</code></li>
<li>Event identifiers <code>id: 0</code></li>
<li>Unnamed events <code>data: Hello\n\n</code></li>
<li>Comment: starts with colon <code>:I am a ...</code></li>
<li>Named events <code>event: status</code></li>
</ul>
</div><div class="column" style="width:55%;">
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource numberLines"><code class="sourceCode"><span id="cb10-1"><a href="#cb10-1"></a>&gt; GET /stream/hello HTTP/1.1</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>&lt; HTTP/1.1 200 OK</span>
<span id="cb10-4"><a href="#cb10-4"></a>&lt; Content-Type: text/event-stream</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a>&lt; retry: 2000</span>
<span id="cb10-7"><a href="#cb10-7"></a>&lt; id: 0</span>
<span id="cb10-8"><a href="#cb10-8"></a>&lt; data: Hello\n\n</span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a>&lt; :I am a comment line</span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a>&lt; id: 1</span>
<span id="cb10-13"><a href="#cb10-13"></a>&lt; event: status</span>
<span id="cb10-14"><a href="#cb10-14"></a>&lt; data: {&quot;warn&quot;:&quot;Service degraded&quot;}\n\n</span></code></pre></div>
</div>
</div>
</div>
<div id="eventsource-custom-events" class="slide section level1">
<h1>EventSource: custom events</h1>
<p>You can subscribe to custom events (e.g.¬†<code>status</code>) with <code>.addEventListener</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource javascript numberLines"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">const</span> source <span class="op">=</span> <span class="kw">new</span> <span class="bu">EventSource</span>(<span class="st">&#39;/stream/hello&#39;</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">// [name]: triggers for custom named event, here: &quot;status&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>source<span class="op">.</span><span class="fu">addEventListener</span>(</span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="st">&quot;status&quot;</span><span class="op">,</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  ({ data }) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;custom event: status&quot;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data))<span class="op">,</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>  <span class="kw">false</span><span class="op">,</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>)<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">// as before, un-named data events</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>source<span class="op">.</span><span class="fu">addEventListener</span>(</span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="st">&quot;message&quot;</span><span class="op">,</span> </span>
<span id="cb11-13"><a href="#cb11-13"></a>  (<span class="bu">event</span>) <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;data event&quot;</span><span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span> }<span class="op">,</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  <span class="kw">false</span><span class="op">,</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="eventsource-connection-events" class="slide section level1">
<h1>EventSource: connection events</h1>
<p>Subscribe to <code>open</code> and <code>error</code> for connection management:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource javascript numberLines"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">// on connection established</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>source<span class="op">.</span><span class="fu">addEventListener</span>(</span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="st">&quot;open&quot;</span><span class="op">,</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  (<span class="bu">event</span>) <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Connection status&quot;</span>)<span class="op">;</span> }<span class="op">,</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="kw">false</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>)<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="co">// on disconnection</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>source<span class="op">.</span><span class="fu">addEventListener</span>(</span>
<span id="cb12-10"><a href="#cb12-10"></a>  <span class="st">&quot;error&quot;</span><span class="op">,</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>  (<span class="bu">event</span>) <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Connection status&quot;</span>)<span class="op">;</span> }<span class="op">,</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>  <span class="kw">false</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="the-eventsource-interface" class="slide section level1">
<h1>The EventSource Interface</h1>
<ul>
<li><code>constructor(url, { withCredentials: boolean })</code>
<ul>
<li><code>withCredentials</code>: instantiate with CORS credentials (default: false)</li>
</ul></li>
<li>Events:
<ul>
<li><code>open</code>: on connection</li>
<li><code>error</code>: on error/disconnection</li>
<li><code>message</code>: on generic data: event received</li>
<li><code>&lt;custom&gt;:</code> on named event received</li>
</ul></li>
<li><code>addEventListener(event_name: string, (event: Event) =&gt; void, bubbles: boolean)</code></li>
<li>readyState: <code>CONNECTING</code> (0) | <code>OPEN</code> (1) | <code>CLOSED</code>(2)
<ul>
<li>CONNECTING: also ‚Äúwaiting to reconnect‚Äù</li>
<li>CLOSED: will not attempt to reconnect</li>
</ul></li>
<li>close()</li>
</ul>
</div>
<div id="error-event-is-a-bit-useless" class="slide section level1">
<h1>Error event is a bit useless</h1>
<ul>
<li><p>Single bit of information: ‚Äúerror‚Äù</p></li>
<li><p>callback signature is <code>(event: Event) =&gt; void</code></p>
<ul>
<li>event.target instanceof EventSource</li>
</ul></li>
<li><p>No reason or message can be derived</p>
<ul>
<li>usually output in console</li>
</ul></li>
<li><p>Some disconnections can be ‚Äúfatal‚Äù, cancelling the reconnection policy.</p></li>
<li><p>Inspect <code>readyState</code> to find out EventSource‚Äôs intent:</p>
<ul>
<li>CONNECTING: will reconnect / waiting to reconnect / reconnecting</li>
<li>CLOSED: will not reconnect</li>
</ul></li>
</ul>
</div>
<div id="implementation-considerations-http1.1-connections-quota" class="slide section level1">
<h1>Implementation Considerations: HTTP/1.1 connections quota</h1>
<p>Browsers implement a <strong>per-hostname connection quota</strong> (6) for HTTP/1.1</p>
<p>Per <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events#listening_for_custom_events">MDN</a>:</p>
<blockquote>
<p>Warning: When not used over HTTP/2, SSE suffers from a <strong>limitation to the maximum number of open connections</strong>, which can be especially painful when opening multiple tabs, as the limit is per browser and is set to a very low number (6). The issue has been marked as ‚ÄúWon‚Äôt fix‚Äù in <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=275955">Chrome</a> and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=906896">Firefox</a>.</p>
</blockquote>
<blockquote>
<p>When using HTTP/2, the maximum number of simultaneous HTTP streams is negotiated between the server and the client (defaults to 100).</p>
</blockquote>
<h2 id="solutions">Solutions</h2>
<ul>
<li><strong>Prefer HTTP/2 where available</strong> (can-i-use 96% yes)</li>
<li>If applicable, use an EventSource within a SharedWorker</li>
<li>Use subdomains for SSE endpoint(s)</li>
</ul>
</div>
<div id="implementation-considerations-reconnecting" class="slide section level1">
<h1>Implementation Considerations: Reconnecting</h1>
<p><strong>Default reconnection behavior implementation is not fully standardized</strong></p>
<p>When a network error is encountered:</p>
<ul>
<li>Firefox: Will <strong>stop</strong> retrying (standard compliant)</li>
<li>Chrome: Will <strong>keep</strong> retrying (actually helpful)</li>
</ul>
<hr />
<p><strong>Consider handling reconnections yourself:</strong></p>
<ul>
<li>Option for exponential backoff strategies</li>
<li>Better connection timeout detection</li>
</ul>
<hr />
<p>Test it out in the <a href="https://github.com/takadenoshi/sse-presentation">playground repo</a>:</p>
<ul>
<li>Start react-app but not the server</li>
<li>Open react-app in Chrome and Firefox</li>
<li>Try to connect to any endpoint</li>
<li>Chrome will keep trying to reconnect vs Firefox will quit after one network error</li>
</ul>
</div>
<div id="implementation-considerations-proxies-1" class="slide section level1">
<h1>Implementation Considerations: Proxies (1)</h1>
<h2 id="proxies-can-kill">Proxies can kill</h2>
<p>Proxies, load balancers and other networking middleware can kill idle connections after a short while.</p>
<p>Two approaches to fix this:</p>
<hr />
<h2 id="comment-not-client-aware">1/ Comment (not client-aware)</h2>
<p>You can emit a comment (any line starting with a colon <code>:</code>)</p>
<pre><code>&lt; :bump</code></pre>
<p>Good enough to keep connection alive.</p>
<p>EventSource won‚Äôt emit any event.</p>
</div>
<div id="implementation-considerations-proxies-2" class="slide section level1">
<h1>Implementation Considerations: Proxies (2)</h1>
<h2 id="proxies-can-kill-1">Proxies can kill</h2>
<p>Proxies, load balancers and other networking middleware can kill idle connections after a short while.</p>
<p>Two approaches to fix this:</p>
<hr />
<h2 id="heartbeat-event-client-aware">2/ Heartbeat event (client-aware)</h2>
<p>Emit a custom ‚Äúheartbeat‚Äù or ‚Äúping‚Äù event every 15 seconds or so:</p>
<pre><code>&lt; event: heartbeat
&lt; data: &quot;&quot;</code></pre>
<p>(data field <strong>must</strong> be present)</p>
<p>The client can listen to this event and use it to detect stale connections:</p>
<p><strong>‚Äúexpect heartbeats every N seconds, otherwise reconnect‚Äù</strong></p>
<p>Preferred approach, especially for important payloads.</p>
</div>
<div id="implementation-considerations-service-workers-firefox" class="slide section level1">
<h1>Implementation Considerations: Service Workers (Firefox)</h1>
<h2 id="firefox-service-workers-eventsource">Firefox Service Workers üíî EventSource</h2>
<p>Firefox has yet to implement support for EventSource in its Service Worker context.</p>
<p>Future people can track the present validity of this statement <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1681218">here</a>.</p>
<p>‚úÖ But you can use it in a SharedWorker</p>
</div>
<div id="implementation-considerations-last-event-id-detail" class="slide section level1">
<h1>Implementation Considerations: Last-Event-ID detail</h1>
<p><strong>If no event is emitted in the subsequent connection‚Äôs lifetime, the Last-Event-ID is reset.</strong></p>
<hr />
<p>When a reconnected session is initialized with <code>Last-Event-ID: Some-id</code></p>
<p>And the connection emits no messages for its lifetime,</p>
<p>Then the Last-Event-ID value is <em>reset</em>.</p>
</div>
<div id="vs-competiting-options" class="slide section level1">
<h1>Vs competiting options</h1>
<div class="columns">
<div class="column" style="width:33%;">
<h2 id="a-polling">1a/ Polling</h2>
<p>Keep requesting new data on an interval</p>
<ul>
<li>Slower</li>
<li>Usually more resource intensive than SSE</li>
</ul>
<p>Benefit: Doesn‚Äôt ‚Äúhog‚Äù a connection (HTTP/1.1)</p>
<h2 id="b-long-polling">1b/ Long Polling</h2>
<p>‚ÄúHanging GET‚Äù - server keeps connection open/hanging until there is something to write.</p>
<p>Client loops the GET request.</p>
</div><div class="column" style="width:32%;">
<h2 id="sse">2/ SSE</h2>
<ul>
<li>Like formalized, reusable long polling</li>
<li>HTTP + REST compatible
<ul>
<li>Works with your existing framework</li>
<li>Works with your existing auth</li>
</ul></li>
<li>Reconnecting</li>
</ul>
</div><div class="column" style="width:32%;">
<h2 id="websockets">3/ Websockets</h2>
<ul>
<li>Not HTTP/REST
<ul>
<li>Websocket server usually a separate beast</li>
</ul></li>
<li>Must bring your own:
<ul>
<li>Routing</li>
<li>Auth</li>
<li>Error handling</li>
<li>TLS Certs (duplicated)</li>
</ul></li>
<li>Pain to debug</li>
<li>Bidirectional/full duplex
<ul>
<li>good if you need it</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="kadena-use-case" class="slide section level1">
<h1>Kadena use case</h1>
<p>Blockchain stuff usually comes with lots of polling.</p>
<p>Kadena‚Äôs Chainweb is 20 ‚Äúbraided‚Äù chains -&gt; 20x polling threads (worst case)</p>
<p><a href="https://github.com/kadena-io/chainweb-stream">Chainweb-stream</a>:</p>
<ul>
<li>SSE Server</li>
<li>Streams transactions of a certain type (specific account or contract)</li>
</ul>
<p><a href="https://github.com/kadena-community/kadena.js/tree/main/packages/libs/chainweb-stream-client">Chainweb-stream-client</a>:</p>
<ul>
<li>Client side lib (node, browser)</li>
<li>Detects stale connections (heartbeat events)</li>
<li>Detects initial connection timeouts</li>
<li>Custom reconnection (exponential backoffs)</li>
</ul>
</div>
<div id="can-i-use" class="slide section level1">
<h1>Can I use?</h1>
<p>Yes (96.11%)</p>
<p><img src="assets/images/caniuse.png" /></p>
<p><a href="https://caniuse.com/eventsource">caniuse.com/eventsource</a></p>
</div>
<div id="almost-done" class="slide section level1">
<h1>Almost Done</h1>
<h2 id="references">References</h2>
<p><a href="https://html.spec.whatwg.org/multipage/comms.html">¬ß 9.1 MessageEvent Interface - HTML Living Standard</a></p>
<p><a href="https://html.spec.whatwg.org/multipage/server-sent-events.html#server-sent-events">¬ß 9.2 Server-Sent Events - HTML Living Standard</a></p>
<h2 id="links">Links</h2>
<p><a href="https://takadenoshi.github.io/sse-presentation/#(1)">Presentation</a></p>
<p><a href="https://github.com/takadenoshi/sse-presentation">Presentation source &amp; SSE playground - Github</a></p>
<h2 id="font">Font</h2>
<p><code>Monospace font:</code> <a href="https://kodemono.com/">Kode mono</a> by Kadena‚Äôs Isa Ozler</p>
</div>
  
  <script src="assets/scripts/index.js" charset="utf-8" type="text/javascript"></script>
</body>
</html>
